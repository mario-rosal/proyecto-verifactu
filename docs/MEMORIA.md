Memoria: El Proyecto VeriFactu

Este documento sirve como un registro t√©cnico y estrat√©gico completo del proyecto VeriFactu, desde su concepci√≥n hasta la finalizaci√≥n de la fase de desarrollo principal.

1. El "Porqu√©": Visi√≥n Estrat√©gica y Oportunidad de Mercado
   1.1. El Problema: La Ley Antifraude (Veri*Factu)
   El proyecto nace como respuesta directa a la Ley Antifraude espa√±ola (Real Decreto 1007/2023), que entra en vigor en 2026. Esta ley impone una transformaci√≥n digital obligatoria en la facturaci√≥n para combatir el fraude fiscal. Los requisitos clave son:
   Inalterabilidad: Prohibici√≥n de borrar o modificar facturas.
   Trazabilidad: Cada factura debe estar encadenada a la anterior mediante una huella digital criptogr√°fica (hash SHA-256).
   Verificabilidad: Todas las facturas deben incluir un c√≥digo QR y la leyenda "VERI*FACTU" para su r√°pida comprobaci√≥n.
   Registro de Eventos: El software debe mantener una "caja negra" (event_log) de todas las operaciones cr√≠ticas.
   1.2. Nuestra Soluci√≥n: Invisibilidad y Cero Fricci√≥n
   En lugar de competir en el saturado mercado de los softwares de facturaci√≥n, nuestro producto es una pasarela de cumplimiento como servicio (Compliance as a Service).
   P√∫blico Objetivo (El "Nicho Dorado"): Nos dirigimos a las PYMES y aut√≥nomos que ya utilizan un software de gesti√≥n o TPV antiguo que no ser√° actualizado. Estas empresas se enfrentan al dilema de una migraci√≥n costosa o el riesgo de sanciones.
   Propuesta de Valor: No vendemos un nuevo programa, sino un "adaptador m√°gico". Nuestra soluci√≥n se integra de forma invisible con su flujo de trabajo actual, haciendo que su software obsoleto cumpla con la nueva ley. Les vendemos continuidad de negocio y tranquilidad fiscal.
   1.3. El Factor Diferencial: El Conector "Impresora Virtual"
   Nuestra ventaja competitiva m√°s potente es la estrategia de onboarding de "cero fricci√≥n". En lugar de una compleja integraci√≥n v√≠a API, el cliente descarga un instalador personalizado desde su dashboard. Este instalador, construido con Electron, crea una "Impresora Virtual" en su sistema. El cliente simplemente "imprime" sus facturas en esta nueva impresora, y nuestro sistema se encarga del resto. La API Key viene pre-configurada, eliminando cualquier barrera t√©cnica para el usuario.
2. El "C√≥mo": Arquitectura T√©cnica y Tecnolog√≠as
   Hemos construido un sistema robusto basado en una arquitectura de microservicios, donde cada componente tiene una responsabilidad clara.
   Backend (verifactu-bff):
   Stack: NestJS (TypeScript), TypeORM, PostgreSQL.
   Rol: Es el "guardi√°n del estado y la l√≥gica de negocio". Gestiona la API REST, la base de datos, la autenticaci√≥n de usuarios (con bcrypt y JWT), la l√≥gica de "Trabajos" as√≠ncronos y la generaci√≥n de API Keys.

   Endpoints relevantes (consolidados):

    - **POST /v1/connector-package** _(JWT-only)_

   - **GET /v1/invoices/:id/pdf** _(p√∫blico seg√∫n guard global)_
      - Genera **PDF A4** en tiempo real con `pdf-lib` + `qrcode`.
      - Imprime visible: leyenda **‚ÄúVERI*FACTU ‚Äî Factura verificable en la sede electr√≥nica de la AEAT‚Äù** y el **`hash_actual`**.
      - La URL del **QR** incluye los campos del `invoice_record` (`emisor_nif`, `serie`, `numero`, `fecha_emision`, `importe_total`, `hash_actual`).
      - **Cabeceras**: `Content-Type: application/pdf`, `Content-Disposition: inline` con nombre `verifactu-&lt;serie&gt;-&lt;numero&gt;.pdf`.

   - **POST /v1/connector-package/tickets** _(JWT-only)_
     - Crea el **ZIP temporal** en `os.tmpdir()` y devuelve `{ url, filename, size, expiresAt }` firmado (HMAC-SHA256, `exp`).
   - **GET /v1/connector-package/tickets/:token** _(p√∫blico por token)_
     - **Valida** firma/expiraci√≥n; sirve el ZIP con `Content-Length` y **borra** el artefacto tras la descarga.

   **Notas de producto**: con la exclusi√≥n de `win-unpacked/` el ZIP t√≠pico queda en **~75‚Äì79 MB** (instalador + config).

   Conector AEAT (verifactu-connector):
   Stack: NestJS (TypeScript), soap.
   Rol: El "servicio de mensajer√≠a" especializado en la comunicaci√≥n SOAP con la AEAT.

   Seguridad (resumen):

   - **Logging estructurado (global)**:
     - Interceptor **global** escribe JSON por l√≠nea en `verifactu-bff/logs/app-YYYY-MM-DD.jsonl`.
     - Propaga `x-request-id` y registra `method`, `url`, `status`, `duration_ms`, etc.

   - **Cabeceras de seguridad (Helmet)** _(nuevo)_:

     - **CSP** compatible con el dashboard: en **dev** permite `\'unsafe-inline\'` y `\'unsafe-eval\'`; en **producci√≥n** es m√°s estricta (sin `\'unsafe-eval\'`).
     - **X-Frame-Options**: `DENY` y **`frame-ancestors \'none\'`** en la propia CSP para impedir _embedding_ no autorizado.
     - **Referrer-Policy**: `strict-origin-when-cross-origin`.
     - **HSTS**: activado **solo en producci√≥n/HTTPS**; desactivado en desarrollo (HTTP) para evitar falsos positivos.
     - **CORS**: **sin cambios** respecto a la configuraci√≥n previa (whitelist por `CORS_ORIGINS`, mismos headers expuestos).
     - **Verificaci√≥n**: `HEAD /v1/healthz` muestra las cabeceras; en dev **no** aparece `Strict-Transport-Security`.

   - **Autenticaci√≥n JWT**: emisi√≥n firmada con **`JWT_SECRET`**; durante rotaci√≥n, las rutas protegidas **aceptan tambi√©n** tokens firmados con **`JWT_SECRET_NEXT`** (ventana de gracia).
   - **ApiKeyGuard global (JWT OR x-api-key)** con _whitelist_ m√≠nima: `OPTIONS`, `GET /healthz`, `POST /v1/auth/login`, `GET /v1/jobs/:id`, `GET /v1/connector-package/tickets/:token` (token firmado).
   - **Descargas con ticket**: `GET /v1/connector-package/tickets/:token` permitido sin JWT **solo** con token HMAC v√°lido (`DOWNLOAD_TICKET_SECRET`) y `exp`; verificaci√≥n con `timingSafeEqual`.
   - **Sin secretos hardcodeados**: `JwtModule` y validadores leen de `.env`; `JWT_SECRET_NEXT` es **opcional** y solo para rotaci√≥n segura.

   - **E2E de tickets (BFF)** :
     - Cobertura (GET `/v1/connector-package/tickets/:token`):
       - ‚úÖ **√âxito** ‚Üí `200 OK`, `Content-Type: application/zip`, `Content-Length` **exacto** y `> 0`, **borrado** del ZIP temporal al finalizar.
       - ‚ùå **Firma inv√°lida** ‚Üí `401 {"message":"Firma inv√°lida"}`.
       - ‚ùå **Token expirado** ‚Üí `401 {"message":"Token expirado"}`.
       - ‚ùå **Reuso del token** (ZIP ya eliminado) ‚Üí `401 {"message":"Artefacto no disponible"}`.
       - üîì **Ruta p√∫blica/whitelist** (sin JWT/x-api-key) con **token malformado** ‚Üí `401 {"message":"Token inv√°lido"}`.
     - Objetivo: asegurar verificabilidad (cabeceras correctas como `Content-Length`) y que **no se re-sirve** ni **re-crea** el artefacto temporal.
     - Estado: suites e2e en verde; se mantiene el test de whitelist existente.
   - **Servicio de purga de temporales (nuevo):**
     - El BFF incluye un servicio `TicketsPurgeService` que elimina los artefactos ZIP temporales en `os.tmpdir()` cuando han superado el TTL+GRACE.
     - Ahora emite siempre un log √∫nico por ejecuci√≥n con el formato `purged N files` (N puede ser 0).
     - Se a√±adi√≥ un test unitario aislado que simula un directorio temporal y verifica tanto el borrado de archivos expirados como el log esperado.

   Simulador AEAT (mock-server.js):
   Stack: Node.js, Express.
   Rol: Un simulador que nos sirve los archivos WSDL/XSD y emula las respuestas SOAP, permiti√©ndonos desarrollar de forma independiente y fiable.
   Orquestador (n8n):
   Rol: El "sistema nervioso central". Gestiona todos los flujos de trabajo as√≠ncronos (onboarding, procesamiento de facturas) y act√∫a como el punto de integraci√≥n para la IA.
   Inteligencia Artificial (Google Gemini):
   Rol: Act√∫a como un conjunto de "agentes expertos" especializados:
   "Gestor de Alta": Limpia y enriquece los datos de nuevos clientes.
   "Copywriter Creativo": Genera mensajes de bienvenida personalizados.
   "Extractor de Datos": Parsea el texto de los PDFs de facturas.
   "Auditor Fiscal": Realiza una pre-validaci√≥n de las facturas.
   Frontend (UI):
   Stack: HTML, JavaScript ("Vanilla JS"), Tailwind CSS.
   Componentes: index.html (Onboarding), login.html, dashboard.html, y las p√°ginas para la recuperaci√≥n de contrase√±a.
   Capacidades del Dashboard (estado actual):

   - Listado de facturas y descarga del **PDF oficial Veri*Factu** (sello + QR) v√≠a **`GET /v1/invoices/:id/pdf`**.
   - **Gesti√≥n de API Keys** (listar, crear ‚Äîse muestra solo una vez‚Äî, revocar) protegida con JWT.
   - **Descarga del Conector**:
     - Flujo **ticketizado**: `POST /v1/connector-package/tickets` ‚Üí navegar a `GET /v1/connector-package/tickets/:token`.
     - Usa _File System Access API_ si est√° disponible para **‚ÄúGuardar como‚Ä¶‚Äù** y progreso en bot√≥n; _fallback_ universal a Blob + `&lt;a download&gt;`.

   Conector de Escritorio (verifactu-printer-connector):
   Stack: Electron, chokidar, electron-store, axios.
   Rol: El "mensajero". Una aplicaci√≥n ligera que vigila una carpeta, lee la API Key de un config.json y env√≠a los nuevos PDFs a n8n.

   **Backups & Restore (consolidado):**

   - **Scripts de backup** (BFF):
     - Windows (PowerShell): `verifactu-bff/scripts/backup/backup.ps1`
     - Bash opcional: `verifactu-bff/scripts/backup/backup.sh`
   - **Funcionamiento:** ejecutan `pg_dump` contra la BD del BFF y generan un artefacto con timestamp en `verifactu-bff/backups/`. Si existe `verifactu-bff/logs/*.jsonl`, se copian al backup.
   - **Requisitos:** tener disponible `pg_dump`. En Windows puede usarse el binario del runtime de pgAdmin 4 (p. ej. `C:\Users\<usuario>\AppData\Local\Programs\pgAdmin 4\runtime\pg_dump.exe`) pas√°ndolo como par√°metro al script.
   - **Restore:** ver gu√≠a `verifactu-bff/docs/RESTORE.md` con el **orden exacto**: definir `DATABASE_URL` o variables `PG*` ‚Üí descomprimir ‚Üí crear BD si no existe ‚Üí `psql -f dump.sql`.
   - **Nota conocida:** si durante el restore aparece el error `unrecognized configuration parameter "transaction_timeout"`, quitar la l√≠nea `SET transaction_timeout` del `.sql` antes de ejecutarlo (seg√∫n versi√≥n/entorno).

3. El "Qu√©": Resumen del Progreso por Sprints
   Sprint 1 (Cimientos): Se construy√≥ el motor del backend (bff y connector) y se tom√≥ la decisi√≥n estrat√©gica de crear el simulador para garantizar la velocidad del desarrollo.
   Sprint 2 (Asincron√≠a e IA): Se refactoriz√≥ el backend a una arquitectura as√≠ncrona basada en "Jobs". Se construy√≥ el flujo de onboarding en n8n con validaci√≥n por IA y se cre√≥ el frontend de registro con sondeo (polling) para una experiencia en tiempo real.
   Sprint 3 (Funcionalidad Principal): Se construy√≥ el dashboard.html y se conect√≥ al backend para mostrar datos reales. Se implement√≥ el flujo completo de n8n para procesar un "Job" de factura, sellarlo en el bff y enviarlo al conector AEAT (simulado).
   Sprint 4 (Seguridad y Acceso): Se implement√≥ el sistema de autenticaci√≥n de usuarios de principio a fin: la tabla users con roles, los endpoints de registro y login con JWT, el AuthGuard para proteger rutas y el flujo completo de recuperaci√≥n de contrase√±a.
   Sprint 5 (El Conector Disruptivo): Se construy√≥ y depur√≥ la aplicaci√≥n de escritorio "Impresora Virtual" con Electron. Se valid√≥ la arquitectura de comunicaci√≥n segura (preload script) y se implement√≥ la l√≥gica para vigilar una carpeta y enviar los archivos a n8n con una API Key pre-configurada.
   Sprint 6 (Cumplimiento Avanzado): Se a√±adieron las capas finales de cumplimiento normativo, destacando la implementaci√≥n del "Libro de Incidencias" (la tabla event_log y los endpoints correspondientes en el bff).

   Sprint 7 (DASH-APIKEYS-UI): Se incorpor√≥ en el dashboard la **gesti√≥n de API Keys** para cada tenant (listar metadatos, crear con visualizaci√≥n √∫nica y revocar). El backend expone `GET/POST/DELETE /api-keys` protegido con JWT; el dashboard consume estos endpoints y muestra feedback de errores.

   **Sprint E/F ‚Äî PDF oficial consolidado**: Se consolid√≥ en el BFF el endpoint **`GET /v1/invoices/:id/pdf`** que genera **en tiempo real** el **PDF oficial Veri*Factu** con leyenda y **QR** (sin dependencias de S3/MinIO). El Dashboard expone el bot√≥n **‚ÄúDescargar Factura Veri*Factu (PDF)‚Äù** que navega a dicho endpoint. El QR codifica la URL de verificaci√≥n con los campos de `invoice_record` (`emisor_nif`, `serie`, `numero`, `fecha_emision`, `importe_total`, `hash_actual`).

   Diagrama del flujo completo:

   ```
   [ERP/TPV Antiguo]
           ‚îÇ (Imprimir PDF)
           ‚ñº
   [Conector Electron]
    (watcher + API Key)
           ‚îÇ
           ‚ñº
     [Webhook n8n]
           ‚îÇ
           ‚îú‚îÄ OCR / IA (Gemini) ‚Üí Datos estructurados
           ‚îÇ
           ‚îî‚îÄ‚ñ∫ BFF /invoices (Job: INVOICE_SUBMISSION)
                     ‚îÇ
                     ‚ñº
              [invoice_record DB]
                     ‚îÇ
                     ‚îî‚îÄ Encadenado con hash
                     ‚îÇ
                     ‚ñº
           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ Sprint E:                     ‚îÇ
           ‚îÇ BFF /invoices/:id/pdf/stamp   ‚îÇ
           ‚îÇ Genera PDF con QR + leyenda   ‚îÇ
           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ Sprint F:                     ‚îÇ
           ‚îÇ Guardar PDF en S3/MinIO       ‚îÇ
           ‚îÇ (stamped/<invoice_id>.pdf)    ‚îÇ
           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
            [Dashboard del Cliente]
           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ GET /invoices/:id/pdf/stamped ‚îÇ
           ‚îÇ Bot√≥n ‚ÄúDescargar Factura‚Äù     ‚îÇ
           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
                     ‚ñº
             [PDF Oficial Veri*Factu]
    (contenido original + sello + QR verificable)
   ```

4. El "Hacia D√≥nde": Pr√≥ximos Pasos
   Con el desarrollo funcional principal ya completado, el proyecto entra en su fase final de preparaci√≥n para el lanzamiento.
   PDF Oficial Consolidado: Ya est√° implementada la generaci√≥n del PDF oficial de la factura con c√≥digo QR y la leyenda "VERI*FACTU", mediante el endpoint `/v1/invoices/:id/pdf/stamp` (subida y estampado) y `/v1/invoices/:id/pdf/stamped` (descarga). El flujo de n8n invoca este servicio tras el sellado.
   Empaquetado y Despliegue: Usamos electron-builder (NSIS y NSIS Web) para crear los instaladores profesionales del conector. El dashboard genera un ZIP con `config.json` y el instalador actualizado. Pr√≥ximo paso: disponer de hosting p√∫blico (S3/MinIO) para servir el paquete `.nsis.7z` del Web-Setup.
   Integraci√≥n Real con la AEAT: El √∫ltimo paso ser√° obtener un certificado de sello electr√≥nico oficial y "cambiar el enchufe" del verifactu-connector, pasando de nuestro simulador al entorno de producci√≥n de la Agencia Tributaria.

   Evidencia t√©cnica (descarga & distribuci√≥n):

   - **Antes (instalador completo)**: `POST /v1/connector-package` ‚Üí ZIP (`config.json` + `.exe`) con `Content-Length` **~75‚Äì79 MB**.
   - **Ahora (NSIS Web)**: bundle de dashboard `verifactu-connector-web.zip` **~0.6 MB** (`Web-Setup.exe` + `config.json`).
   - `POST /v1/connector-package/tickets` ‚Üí devuelve `url` firmada + `size`; `GET` posterior entrega el ZIP y elimina el temporal.
   - `event_log` registra `CONFIG_UPDATE` en ambos flujos (con `ticket: true` cuando aplica).

### Anexo A ‚Äî Variables de entorno (producci√≥n y rotaci√≥n)

| Variable                            | Uso                                | Notas                                                       |
| ----------------------------------- | ---------------------------------- | ----------------------------------------------------------- |
| `NODE_ENV`                          | entorno                            | `production` en despliegue                                  |
| `PORT`                              | puerto BFF                         | por defecto `3001`                                          |
| `CORS_ORIGINS`                      | **whitelist CORS** (coma-separado) | ej. `https://app.midominio.com,https://admin.midominio.com` |
| `JWT_SECRET`                        | firma/verificaci√≥n JWT             | **obligatorio**                                             |
| `JWT_SECRET_NEXT` (opcional)        | **rotaci√≥n** JWT                   | aceptar dual en ventana de gracia                           |
| `DOWNLOAD_TICKET_SECRET`            | HMAC tickets de descarga           | **obligatorio** ¬∑ **m√≠nimo 24 chars** (validado en runtime) |
| `DOWNLOAD_TICKET_SECRET_NEXT` (op.) | **rotaci√≥n** de tickets            | verificaci√≥n intenta ambos                                  |

**Operativa de rotaci√≥n** (JWT/tickets):

1. Generar y cargar `*_NEXT` en `.env`.
2. Desplegar (aceptaci√≥n **dual**).
3. Promocionar: mover `*_NEXT` ‚Üí base (`JWT_SECRET` / `DOWNLOAD_TICKET_SECRET`) y vaciar `*_NEXT`.
4. Revocar el secreto antiguo (tokens antiguos dejan de ser v√°lidos tras la gracia).

5. Flujo Completo: De Cero a Factura Legal
   Aqu√≠ se detalla el viaje completo del usuario, desde que descubre el servicio hasta que emite su primera factura 100% legal.
   Fase A: Onboarding y Puesta en Marcha
   Registro (Frontend): Un nuevo cliente (ej. un restaurante) llega a nuestra web y rellena el formulario de index.html con los datos de su empresa y los de su cuenta de administrador.
   Orquestaci√≥n del Alta (n8n): El formulario env√≠a los datos a un workflow de n8n. Este flujo utiliza un agente de IA para limpiar y validar los datos. Si todo es correcto, llama a nuestro bff.
   Creaci√≥n en Backend (bff): El bff ejecuta una transacci√≥n segura que crea el tenant (la empresa), el primer user (el administrador) y genera autom√°ticamente la primera API Key √∫nica para ese cliente.
   Bienvenida y Login: El usuario es redirigido a la p√°gina de login.html y puede iniciar sesi√≥n con las credenciales que acaba de crear.
   Descarga del Conector (Dashboard): Al iniciar sesi√≥n, el usuario accede a su dashboard.html. Aqu√≠ encuentra un bot√≥n **‚ÄúDescargar Conector‚Äù**. Al hacer clic, nuestro **bff** invoca `POST /connector-package` y entrega un **ZIP** que contiene:

   - **Instalador Windows** del conector (Electron/NSIS), cuando est√° disponible.
   - **`config.json`** con una **API Key dedicada** y el **tenantId** generados justo en esa solicitud.
     Instalaci√≥n "Cero Fricci√≥n" (Electron): El usuario instala el conector. En su primer arranque, la aplicaci√≥n detecta el config.json, guarda la API Key de forma segura y le pide al usuario que seleccione la carpeta donde su TPV "imprime" las facturas en PDF. A partir de este momento, el conector se inicia autom√°ticamente con el ordenador y trabaja en segundo plano.
     Fase B: Emisi√≥n de una Factura (El D√≠a a D√≠a)
     "Impresi√≥n" desde el Software Antiguo: El camarero del restaurante genera una factura en su TPV como siempre. Al finalizar, en lugar de imprimirla en papel, la "imprime" en la carpeta que el conector est√° vigilando.
     Detecci√≥n y Env√≠o (Electron): Nuestro conector (chokidar) detecta el nuevo archivo PDF al instante. Lee la API Key guardada y env√≠a el archivo PDF de forma segura a un webhook espec√≠fico de n8n.
     Procesamiento Inteligente (n8n):
     El workflow [Facturacion] - 3. Procesador de PDFs recibe el archivo.
     Valida la API Key contra nuestro bff para identificar al cliente.
     Usa un nodo de OCR para extraer el texto del PDF.
     Le pasa el texto a un agente de IA (Gemini) que lo estructura en un formato JSON limpio.
     Llama al bff para crear un "Job" de tipo INVOICE_SUBMISSION con los datos extra√≠dos.
     Activa el workflow [Facturacion] - 2. Procesador As√≠ncrono.
     Sellado y Env√≠o (n8n y bff):
     El segundo workflow de n8n realiza las validaciones finales (NIF del receptor, etc.).
     Llama al endpoint inteligente del bff para que calcule el hash encadenado y guarde el registro oficial de la factura (invoice_record) en la base de datos.
     Finalmente, le pasa la factura ya sellada al verifactu-connector para su comunicaci√≥n con la AEAT (simulada).
     **Generaci√≥n del Documento Final (Consolidado):** el BFF genera el PDF oficial con QR y leyenda "VERI*FACTU" y lo expone v√≠a `GET /v1/invoices/:id/pdf`.
     Disponibilidad en el Dashboard: El due√±o del restaurante, al entrar en su dashboard.html, ver√° la nueva factura en su listado, con el estado "Completado". Desde ah√≠, podr√° descargar el PDF oficial y legal, que es el que debe entregar a su cliente.

6. El Principio de la "Fuente √önica de la Verdad" (Single Source of Truth)
   Lo m√°s importante que hay que entender es que, desde el momento en que un cliente empieza a usar nuestro sistema, su software antiguo (su TPV, su Word, su Excel) pierde toda validez fiscal. Se convierte en una simple herramienta para introducir datos.
   Nuestra plataforma se convierte en la √∫nica y exclusiva "Fuente de la Verdad" para sus facturas.
   ¬øQu√© implicaciones tiene esto?
   Validez Legal: La √∫nica factura que es legalmente v√°lida es la que se genera en nuestro sistema y se puede descargar desde nuestro Dashboard. Esa es la que contiene el hash, el QR y la que, en caso de inspecci√≥n, la AEAT considerar√° como el documento oficial.
   Confianza y Responsabilidad: Esto significa que el cliente deposita en nosotros una confianza total para la custodia de sus registros fiscales. No somos un complemento, somos su nuevo libro de contabilidad digital y oficial. Esto subraya la importancia de la seguridad, las copias de seguridad y la fiabilidad de toda la arquitectura que hemos construido.
   Modelo de Negocio (Suscripci√≥n): Este principio justifica perfectamente un modelo de negocio por suscripci√≥n mensual o anual. El cliente no paga por un programa, paga por un servicio continuo de custodia, legalidad y tranquilidad fiscal. Mientras pague, su "archivo fiscal" est√° seguro y accesible en nuestro dashboard.
   Este concepto es el argumento de venta m√°s potente que ten√©is. No ofrec√©is una simple herramienta, ofrec√©is convertiros en el departamento de cumplimiento normativo digital de vuestros clientes.